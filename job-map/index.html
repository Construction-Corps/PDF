<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Job Map</title>
  <style>
    /* Simple styling for the jobs list */
    #jobsList div {
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <h1>Job List</h1>
  <div id="jobsList">
    <!-- Job items will be inserted here -->
  </div>
  
  <script>
    // Use the production Django proxy endpoint
    const proxyEndpoint = "http://127.0.0.1:8000/actions/api/jobtread-proxy/";
    const grantKey = "22SkCV5JXCtY6eKk5w2ZWBsyhpBBrr6Lea";
    const organizationId = "22NwWhUAf6VB";
    
    // Define a Pave query that gets the organization's jobs.
    const query = {
      "query": {
        "$": { "grantKey": grantKey },
        "organization": {
          "$": { "id": organizationId },
          "id": {},
          "jobs": {
            "nextPage": {},
            $:{
              "size": 100,
              "with": {
                "cf": {
                  "_": "customFieldValues",
                  "$": {
                    "where": [
                    [
                    "customField",
                    "id"
                    ],
                    "22NwzQcjYUA4"
                    ]
                  },
                  "values": {
                    "$": {
                      "field": "value"
                    }
                  }
                }
              },
              "where": {
                "and": [
                ["closedOn","=",null],
                {
                  "or": [
                  [["cf", "values"], "=", "Job Started"],
                  [["cf", "values"], "=", "Job Mid Way"],
                  [["cf", "values"], "=", "Job Complete"],
                  [["cf", "values"], "=", "Design Sold"],
                  [["cf", "values"], "=", "SELL THE PROJECT!!!"],
                  [["cf", "values"], "=", "At Cost"]                                  
                  ] 
                }
                ]
              }
            },
            "nodes": {
              "id": {},
              "name": {},
              "location": {
                "city": {},
                "street": {},
                "state": {},
                "postalCode": {},
                "id": {}
              },
              "createdAt": {},
              "customFieldValues": {
                "nodes": {
                  "id": {},
                  "value": {},
                  // todo this works but when I add this one below it breaks 
                  // the query becuase it's too large I need to figure out 
                  // how to only include some custom fields and not all of them.
                  // "customField": {
                  //   "name": {},
                  //   "id": {}
                  // }
                  
                }
              }
            }
          }
        }
      }
    };
    
    // Issue the POST request using fetch to your Django proxy endpoint
    fetch(proxyEndpoint, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(query)
    })
    .then(response => response.json())
    .then(data => {
      // Extract job nodes from the response.
      const jobsList = data.organization && data.organization.jobs && data.organization.jobs.nodes;
      const jobsContainer = document.getElementById("jobsList");
      
      if (jobsList && jobsList.length > 0) {
        jobsList.forEach(job => {
          const jobDiv = document.createElement("div");
          jobDiv.textContent = `Job: ${job.name} (ID: ${job.id}, City: ${job.location.city})`;
          jobsContainer.appendChild(jobDiv);

        });
      } else {
        jobsContainer.textContent = "No jobs found.";
      }
    })
    .catch(error => {
      console.error("Error fetching jobs:", error);
      document.getElementById("jobsList").textContent = "Error loading jobs.";
    });
  </script>
</body>
</html>